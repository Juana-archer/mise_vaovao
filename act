#!/bin/bash

# NE PAS METTRE LE TOKEN DANS LE SCRIPT !
# Nous allons le demander lors de l'exÃ©cution

echo "ðŸ” CRÃ‰ATION SÃ‰CURISÃ‰E DE DÃ‰PÃ”T GITHUB"
echo "======================================"

# Demander le token (ne sera pas affichÃ©)
read -sp "ðŸ”‘ Token GitHub (ne sera pas affichÃ©): " TOKEN
echo ""

# Demander le nom du dÃ©pÃ´t
read -p "ðŸ“ Nom du nouveau dÃ©pÃ´t: " REPO_NAME
read -p "ðŸ“‹ Description (optionnel): " DESCRIPTION

GITHUB_USER="Juana-archer"

echo ""
echo "ðŸ“¦ CrÃ©ation du dÃ©pÃ´t '$REPO_NAME'..."

# 1. CrÃ©er le dÃ©pÃ´t sur GitHub
RESPONSE=$(curl -s -w "%{http_code}" -X POST \
  -H "Authorization: token $TOKEN" \
  -H "Accept: application/vnd.github.v3+json" \
  https://api.github.com/user/repos \
  -d "{\"name\":\"$REPO_NAME\",\"private\":false,\"description\":\"$DESCRIPTION\"}")

HTTP_CODE=${RESPONSE: -3}
RESPONSE_BODY=${RESPONSE:0:-3}

if [ "$HTTP_CODE" = "201" ]; then
    echo "âœ… DÃ©pÃ´t crÃ©Ã© sur GitHub!"
else
    echo "âŒ Erreur lors de la crÃ©ation"
    echo "Code: $HTTP_CODE"
    echo "$RESPONSE_BODY" | grep -o '"message":"[^"]*"' | head -1
    exit 1
fi

# 2. CrÃ©er le dossier local
cd ~
if [ -d "$REPO_NAME" ]; then
    echo "âš ï¸  Le dossier existe dÃ©jÃ , Ã©crasement..."
    rm -rf "$REPO_NAME"
fi

mkdir "$REPO_NAME"
cd "$REPO_NAME"

# 3. Initialiser Git
git init
git config user.name "$GITHUB_USER"
git config user.email "$GITHUB_USER@users.noreply.github.com"

# 4. Copier TOUS les fichiers depuis ~/maj
echo "ðŸ“ Copie des fichiers depuis ~/jessi..."
cp -r ~/jessi/* .

# 5. VÃ©rifier les fichiers copiÃ©s
echo ""
echo "ðŸ“‹ Fichiers copiÃ©s:"
ls -1

# 6. CrÃ©er un README.md
cat > README.md << README
# $REPO_NAME

$DESCRIPTION

## Fichiers transfÃ©rÃ©s depuis ~/jessi

$(for file in $(ls ~/jessi/); do echo "- \`$file\`"; done)

## Date de transfert
$(date)

CrÃ©Ã© depuis Termux sur Android.
README

# 7. Ajouter le remote GitHub
git remote add origin "https://${TOKEN}@github.com/${GITHUB_USER}/${REPO_NAME}.git"

# 8. Premier commit
git add .
COMMIT_MSG="Initial commit: Transfert des fichiers depuis ~/jessi

Fichiers inclus:"
for file in $(ls ~/jessi/); do
    COMMIT_MSG="$COMMIT_MSG
- $file"
done
git commit -m "$COMMIT_MSG"

# 9. Pousser vers GitHub
echo ""
echo "â¬†ï¸  Envoi vers GitHub..."
git branch -M main
if git push -u origin main; then
    echo "âœ… Push rÃ©ussi!"
else
    echo "âŒ Erreur lors du push"
    exit 1
fi

# 10. Nettoyer le token de la mÃ©moire
TOKEN=""
unset TOKEN

echo ""
echo "ðŸŽ‰ DÃ‰PÃ”T CRÃ‰Ã‰ AVEC SUCCÃˆS !"
echo "============================"
echo "ðŸ”— URL: https://github.com/$GITHUB_USER/$REPO_NAME"
echo "ðŸ“ Dossier local: ~/$REPO_NAME"
echo ""
echo "âš ï¸  IMPORTANT: Votre token a Ã©tÃ© utilisÃ© mais pas sauvegardÃ©."
echo "   Vous pouvez continuer en utilisant HTTPS avec mot de passe/token."
